{% extends "base.html.twig" %}
{% block body %}
    {{ form_start(form) }}
    {{ form_row(form.event) }}
    {{ form_row(form.debut) }}
    <div class="container">
    <button type="button" name="__planning__" class="btn btn-primary btn-lg">Ajouter une date</button>
        <ul class="date" data-prototype="{{ form_row(form.journees.vars.prototype.date)|e('html_attr') }}{{ form_row(form.journees.vars.prototype.dureeHeure)|e('html_attr') }}{{ form_row(form.journees.vars.prototype.dureeMinute)|e('html_attr') }}{{ form_row(form.journees.vars.prototype.nombrePersonnes)|e('html_attr') }}" data-prototype-h="{{ form_row(form.journees.vars.prototype.heures.vars.prototype)|e('html_attr') }}">
        </ul>
    </div>
    {{ form_row(form.save) }}
    {{ form_end(form) }}

{% endblock %}
    {% block javascripts %}
       {{ parent() }}

    <script>
    const $newLinkLi = $('<li></li>');
    const $container = $("ul.date");
    var $data;

    jQuery(document).ready(function() {
        let $collectionHolder = $container;
        $collectionHolder.append($newLinkLi);
        $collectionHolder.data('index', $collectionHolder.find(':input').length);
        let $collectionHeure = $container;
        $collectionHeure.append($newLinkLi);
        $collectionHeure.data('index', $collectionHeure.find(':input').length);

        $('[name="__planning__"]').on('click', function() {
            addTagForm($collectionHolder, $newLinkLi);
            $('[name="__heures__"]').on('click', function(event) {
                var $data = $(this).attr('data');
                addHeure($collectionHeure, $newLinkLi, $data);
                event.stopImmediatePropagation();
            });
        });
    });

    function addTagForm($collectionHolder, $newLinkLi) {
        let prototype = $collectionHolder.data('prototype');
        let index = $collectionHolder.data('index');
        let newForm = prototype.replace(/__journee__/g, index);
        $collectionHolder.data('index', index + 1);
        let $newFormLi = $('<ul id="date_' + index + '" class="date row"></ul>').append(newForm);
        $newFormLi.append('<button type="button" name="__heures__"  data="' + index + '" class="btn btn-secondary">Ajouter une plage horaire</button>');
        $newFormLi.append('<button type="button" class="remove-tag btn btn-danger">Supprimer la date</button>');
        $newLinkLi.before($newFormLi);
        $('.remove-tag').click(function() {
            $(this).parent().remove();
            return false;
        });
        $('.btn').click(function() {
            return false;
        });
    }
    function addHeure($collectionHeure, $newLinkLi, $data) {
        let prototype = $collectionHeure.data('prototype-h');
        let index = $collectionHeure.data('index');
        let newForm = prototype.replace(/__name__/g, index).replace(/__journee__/g, $data);
        $collectionHeure.data('index', index + 1);
        let $newFormLi = $('ul#date_' + $data).append(newForm);
        $newFormLi.children('#planning_journees_' + $data + '_heures_' + index + 'div').append('<button type="button" class="remove-tag btn btn-warning">Supprimer la plage horaire</button>');
        $('.remove-tag').click(function() {
            $(this).closest('').remove();
            return false;
        });
        }
    </script>
{% endblock %}